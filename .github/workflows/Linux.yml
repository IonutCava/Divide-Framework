name: Linux Builds

on:
  schedule:
    - cron: "0 0 * * *"
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:
    inputs:
      runner_type:
        description: 'Runner type to run on (GitHub or Self Hosted)'
        required: false
        default: 'GitHub'
        type: choice
        options:
        - GitHub
        - self-hosted

run-name: Linux Build - ${{ github.ref_name }} - ${{ github.event.inputs.runner_type || 'GitHub' }}

jobs:
  check_date:
   runs-on: ubuntu-latest
   outputs:
      should_run: ${{ steps.check.outputs.should_run }}
   steps:
      - uses: actions/checkout@v4 
        with:
         fetch-depth: 1
         submodules: false
      - id: check
        uses: ./.github/actions/check-date

  info_job:
    needs: check_date
    if: ${{ needs.check_date.outputs.should_run != 'false' }}
    name: Ubuntu latest - Print Info
    runs-on: ${{ github.event.inputs.runner_type == 'self-hosted' && fromJson('["self-hosted","Linux"]') || 'ubuntu-latest' }}

    steps:
    - name: Print GCC version
      run: g++ --version 

    - name: Print CLANG version
      run: clang --version 

  build_gcc:
    needs: info_job
    name: Ubuntu latest - gcc ${{ matrix.build-type }} ${{ matrix.configuration }}
    runs-on: ${{ github.event.inputs.runner_type == 'self-hosted' && fromJson('["self-hosted","Linux"]') || 'ubuntu-latest' }}
    strategy:
      fail-fast: true
      matrix:
        build-type: [editor, game]
        configuration: [debug, release, profile]
    timeout-minutes: 180
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false
          
          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - uses: actions/checkout@v4

      - uses: ./.github/actions/build-setup/linux
        with:
          runner_type: ${{ github.event.inputs.runner_type || 'GitHub' }}

      - uses: ./.github/actions/cmake-build/linux
        with:
          compiler: gcc
          build-type: ${{ matrix.build-type }}
          configuration: ${{ matrix.configuration }}

  build_clang:
    needs: info_job
    name: Ubuntu latest - clang ${{ matrix.build-type }} ${{ matrix.configuration }}
    runs-on: ${{ github.event.inputs.runner_type == 'self-hosted' && fromJson('["self-hosted","Linux"]') || 'ubuntu-latest' }}
    strategy:
      fail-fast: true
      matrix:
        build-type: [editor, game]
        configuration: [debug, release]
    timeout-minutes: 180
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: true

      - uses: actions/checkout@v4

      - uses: ./.github/actions/build-setup/linux
        with:
          runner_type: ${{ github.event.inputs.runner_type || 'GitHub' }}

      - uses: ./.github/actions/cmake-build/linux
        with:
          compiler: clang
          build-type: ${{ matrix.build-type }}
          configuration: ${{ matrix.configuration }}

  build_clang_asan_ubsan:
    needs: info_job
    name: Ubuntu - clang ASAN+UBSAN (debug/editor)
    runs-on: ${{ github.event.inputs.runner_type == 'self-hosted' && fromJson('["self-hosted","Linux"]') || 'ubuntu-latest' }}
    timeout-minutes: 90
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: true

      - uses: actions/checkout@v4

      - uses: ./.github/actions/build-setup/linux
        with:
          runner_type: ${{ github.event.inputs.runner_type || 'GitHub' }}

      - uses: ./.github/actions/cmake-build/linux
        with:
          compiler: clang
          build-type: editor
          configuration: debug
          configure-preset: linux-clang-editor-asan-ubsan
          build-preset: linux-clang-debug-editor-asan-ubsan
          test-preset: test-linux-clang-debug-editor-asan-ubsan

  build_gcc_asan_ubsan:
    needs: info_job
    name: Ubuntu - gcc ASAN+UBSAN (debug/editor)
    runs-on: ${{ github.event.inputs.runner_type == 'self-hosted' && fromJson('["self-hosted","Linux"]') || 'ubuntu-latest' }}
    timeout-minutes: 90
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false
          
          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
        
      - uses: actions/checkout@v4

      - uses: ./.github/actions/build-setup/linux
        with:
          runner_type: ${{ github.event.inputs.runner_type || 'GitHub' }}

      - uses: ./.github/actions/cmake-build/linux
        with:
          compiler: gcc
          build-type: editor
          configuration: debug
          configure-preset: linux-gcc-editor-asan-ubsan
          build-preset: linux-gcc-debug-editor-asan-ubsan
          test-preset: test-linux-gcc-debug-editor-asan-ubsan

  output_job:
    needs: [build_gcc, build_clang, build_clang_asan_ubsan, build_gcc_asan_ubsan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Retrieve results
        id: results
        run: |
          if [[ "${{ needs.build_gcc.result }}" == "failure" || "${{ needs.build_clang.result }}" == "failure" || "${{ needs.build_clang_asan_ubsan.result }}" == "failure" || "${{ needs.build_gcc_asan_ubsan.result }}" == "failure" ]]; then
            echo "status=Build failed" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.build_gcc.result }}" == "cancelled" || "${{ needs.build_clang.result }}" == "cancelled" || "${{ needs.build_clang_asan_ubsan.result }}" == "cancelled" || "${{ needs.build_gcc_asan_ubsan.result }}" == "cancelled" ]]; then
            echo "status=Builds cancelled" >> $GITHUB_OUTPUT
          else
            echo "status=Success" >> $GITHUB_OUTPUT
          fi

      - name: Report Status
        run: echo "${{ steps.results.outputs.status }}"
